---
name: Copilot Sync

on:
  # Manual trigger so you can run the sync on demand.
  workflow_dispatch:

# Default to no permissions; grant only what the job needs.
permissions: {}

jobs:
  copilot-sync:
    name: Copilot Sync
    runs-on: ubuntu-latest
    permissions:
      # Required to write the synced files back to the repo.
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Use the GITHUB_TOKEN from the job instead of a persisted checkout token.
          persist-credentials: false

      - name: Process .github/copilot-sync.json
        id: process_config
        run: |
          # Read sync metadata from the local config file.
          sync_repo="$(jq --raw-output '.repo' .github/copilot-sync.json)"
          echo "SYNC_REPO=${sync_repo}" >>"${GITHUB_ENV}"

          sync_ref="$(jq --raw-output '.ref' .github/copilot-sync.json)"
          echo "SYNC_REF=${sync_ref}" >>"${GITHUB_ENV}"

      - name: Resolve latest release
        id: resolve_latest_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the latest release tag for the distribution repo.
          latest_ref=$(gh release list \
            --repo "${SYNC_REPO}" \
            --json "tagName,isLatest" | jq --raw-output '.[] | select(.isLatest == true) | .tagName')

          if [[ -n "${latest_ref}" && "${latest_ref}" != "null" ]]; then
            echo "SYNC_REF_LATEST=${latest_ref}" >>"${GITHUB_ENV}"
          else
            echo "SYNC_REF_LATEST=${SYNC_REF}" >>"${GITHUB_ENV}"
          fi

      - name: Update sync ref if newer
        id: update_sync_ref
        run: |
          # Use latest ref if it differs from config, and persist to copilot-sync.json.
          if [[ "${SYNC_REF_LATEST}" != "${SYNC_REF}" ]]; then
            tmp_file="$(mktemp)"
            jq --arg new_ref "${SYNC_REF_LATEST}" '.ref = $new_ref' .github/copilot-sync.json >"${tmp_file}"
            mv "${tmp_file}" .github/copilot-sync.json
            echo "SYNC_REF=${SYNC_REF_LATEST}" >>"${GITHUB_ENV}"
            echo "Updated sync ref to ${SYNC_REF_LATEST}"
          fi

      - name: Check for existing pull request
        id: check_existing_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if a PR for this SYNC_REF is already open.
          existing_pr_number=$(gh pr list \
            --app "github-actions" \
            --state open \
            --search ":copilot: Sync Copilot instructions from ${SYNC_REPO}@${SYNC_REF}" \
            --json "number" | jq --raw-output '.[0].number')

          if [[ -n "${existing_pr_number}" && "${existing_pr_number}" != "null" ]]; then
            echo "Existing pull request found: ${existing_pr_number}"
            echo "PR_ALREADY_OPEN=true" >>"${GITHUB_ENV}"
            echo "EXISTING_PULL_REQUEST=${existing_pr_number}" >>"${GITHUB_ENV}"
          else
            echo "No existing pull request found"
            echo "PR_ALREADY_OPEN=false" >>"${GITHUB_ENV}"
          fi

      - name: Sync Copilot instructions
        id: sync_instructions
        if: env.PR_ALREADY_OPEN != 'true'
        run: |
          set -euo pipefail

          # Load the instruction names from config as a list.
          instructions=$(jq --raw-output '.instructions[]' .github/copilot-sync.json)
          # Base URL for raw files in the distribution repo.
          base_url="https://raw.githubusercontent.com/${SYNC_REPO}/${SYNC_REF}/copilot-instructions"

          # Track files we want to exist after sync.
          desired_files=()

          for instruction in ${instructions}; do
            # Special case: copilot-instructions has a different filename.
            if [[ "${instruction}" == "copilot-instructions" ]]; then
              src_path="${instruction}.md"
              dest_path=".github/${instruction}.md"
            else
              src_path="${instruction}.instructions.md"
              dest_path=".github/${instruction}.instructions.md"
            fi

            # Download the file from the distribution repo.
            curl --fail --silent --show-error --location "${base_url}/${src_path}" --output "${dest_path}"
            desired_files+=("${dest_path}")
            echo "Synced ${instruction} -> ${dest_path}"
          done

          # Find existing instruction files in .github.
          mapfile -t existing_files < <(find .github -maxdepth 1 -type f \( -name "*.instructions.md" -o -name "copilot-instructions.md" \) -print)

          for existing in "${existing_files[@]}"; do
            keep=false
            for desired in "${desired_files[@]}"; do
              if [[ "${existing}" == "${desired}" ]]; then
                keep=true
                break
              fi
            done

            # Remove files no longer in the mapping.
            if [[ "${keep}" == "false" ]]; then
              rm --force "${existing}"
              echo "Removed stale ${existing}"
            fi
          done

      - name: Detect Changes
        id: detect_changes
        if: env.PR_ALREADY_OPEN != 'true'
        run: |
          # Detect any changes (including untracked files).
          if git status --porcelain --untracked-files=all | grep --quiet .; then
            echo "CHANGES_DETECTED=true" >>"${GITHUB_ENV}"
          else
            echo "CHANGES_DETECTED=false" >>"${GITHUB_ENV}"
          fi
      
      - name: Create branch
        id: create_branch
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a unique branch for this sync run.
          branch_name="copilot-sync-${SYNC_REF}-${GITHUB_RUN_ID}"
          echo "BRANCH_NAME=${branch_name}" >>"${GITHUB_ENV}"

          gh api \
            --method POST "/repos/${{ github.repository }}/git/refs" \
            --raw-field ref="refs/heads/${branch_name}" \
            --raw-field sha="$(git rev-parse HEAD)"

      - name: Commit changes
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true'
        id: commit_changes
        uses: planetscale/ghcommit-action@25309d8005ac7c3bcd61d3fe19b69e0fe47dbdde # v0.2.20
        with:
          # Commit only the instruction files.
          commit_message: ":copilot: Sync Copilot instructions from ${SYNC_REPO}@${SYNC_REF}"
          file_pattern: ".github/*instructions.md .github/copilot-sync.json"
          repo: ${{ github.repository }}
          branch: ${{ env.BRANCH_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check branch divergence
        id: check_branch_divergence
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          # Ensure the branch is ahead of main before opening a PR.
          ahead_by=$(gh api \
            --method GET "/repos/${{ github.repository }}/compare/main...${BRANCH_NAME}" \
            --jq '.ahead_by')

          if [[ "${ahead_by}" -gt 0 ]]; then
            echo "BRANCH_HAS_CHANGES=true" >>"${GITHUB_ENV}"
          else
            echo "BRANCH_HAS_CHANGES=false" >>"${GITHUB_ENV}"
          fi

      - name: Find previous pull request
        id: find_previous_pr
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true' && env.BRANCH_HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find older open PRs for this repo but different sync refs.
          previous_pull_requests=$(gh pr list \
            --app "github-actions" \
            --state open \
            --search ":copilot: Sync Copilot instructions from ${SYNC_REPO}@" \
            --json "number,title" | jq --raw-output \
              --arg current_ref "${SYNC_REF}" \
              --arg repo "${SYNC_REPO}" \
              '.[] | select(.title | contains($repo + "@" + $current_ref) | not) | .number')

          previous_pull_requests_list=$(echo "${previous_pull_requests}" | tr '\n' ' ' | sed 's/[[:space:]]*$//')

          if [[ -z "${previous_pull_requests_list}" ]]; then
            echo "No previous pull requests found"
          else
            echo "Found previous pull requests: ${previous_pull_requests_list}"
            echo "PREVIOUS_PULL_REQUESTS=${previous_pull_requests_list}" >>"${GITHUB_ENV}"
          fi

      - name: Create pull request
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true' && env.BRANCH_HAS_CHANGES == 'true'
        id: create_pull_request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          # Open a new PR for the sync changes.
          pull_request_url=$(gh pr create \
            --title ":copilot: Sync Copilot instructions from ${SYNC_REPO}@${SYNC_REF}" \
            --body "This pull request syncs Copilot instructions from ${SYNC_REPO}@${SYNC_REF}." \
            --head "${BRANCH_NAME}" \
            --base "main")
          echo "PULL_REQUEST_URL=${pull_request_url}" >>"${GITHUB_ENV}"

      - name: Close previous pull request
        if: env.CHANGES_DETECTED == 'true' && env.PR_ALREADY_OPEN != 'true' && env.BRANCH_HAS_CHANGES == 'true' && env.PREVIOUS_PULL_REQUESTS != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIOUS_PULL_REQUESTS: ${{ env.PREVIOUS_PULL_REQUESTS }}
          NEW_PULL_REQUEST: ${{ env.PULL_REQUEST_URL }}
        run: |
          # Close any superseded PRs for older sync refs.
          for pr_number in ${PREVIOUS_PULL_REQUESTS}; do
            gh pr close "${pr_number}" --comment "Superseded by ${NEW_PULL_REQUEST}" --delete-branch
          done